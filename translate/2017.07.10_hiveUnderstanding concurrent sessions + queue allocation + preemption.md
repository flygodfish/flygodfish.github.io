## [Hive - Understanding concurrent sessions + queue allocation + preemption](https://community.hortonworks.com/articles/56636/hive-understanding-concurrent-sessions-queue-alloc.html)


### 在这篇文章里：
- 展示了hive sessions是如何工作的
- 澄清了一些误解关于hive sessions的行为（大部分人，包括我知道最近，相信hive sessions和queue allocation不同于他们的实际工作方式）
- 一个有建设的解决办法给中小环境（多达200个节点），允许并发用户 + 多租户（单一软件程序为多个客户服务的架构）+ 软件分配 +　抢占权

### 假定：
在HDP2.4.0上测试
我正在使用的是最佳实践推荐的配置和安全性和Hive性能指南有关的文档（http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_performance_tuning/content/ch_hive_architectural_overview.html）
包含以下配置：
- hive engine (hive.execution.engine) = tez
- hive do-as (hive.server2.enable.doAs) = false
- hive default queues (hive.server2.tez.default.queues) = (queue-name1,queue-name2,etc)
- hive number of sessions (hive.server2.tez.sessions.per.default.queue) = 1 (or up to 4)
- hive start sessions (hive.server2.tez.initialize.default.sessions) = true
- hive pre-warm containers (hive.prewarm.enabled) = true
- hive num-containers (hive.prewarm.numcontainers) = (some number >1)
- tez container reuse (tez.am.container.reuse.enabled) = true
所有的例子都是关于hiveserver2 + jdbc client (beeline/other jdbc client or odbc driver)，它并不适用于hive client或者其它能直接影响hive meta store的工具

### 理解#1 - 默认的队列 + 许多会话
当你定义hive默认队列（hive.server2.tez.default.queues）和hive的会话数x（hive.server2.tez.sessions.per.default.queue=x）和hive开始会话为真（hive.server2.tez.initialize.default.sessions=true）时，hiveserver2启动时将会创建一个Tez AM(application master)给每一个默认队列x个会话数。

举例，如果你定义默认队列是“queue1,queue2”和会话数为2，hiveserver2将会创建4个Tez AM(2个给queue1,2个给queue2)

如果你连续使用hiveserver2，这些Tez AM将会持续运行，但是如果你的hiveserver2是闲置的，这些Tez AM将会基于被定义的超时时间（tez.session.am.dag.submit.timeout.secs）被杀死。

### 理解#2 - 预热容器
预热容器不同于会话的初始化。

容器的数量与在默认情况下连接到每个Tez AM的YARN执行容器（并不考虑AM容器）数量有关。甚至当Tez AM空闲时，每个AM也将会持有相同数量的容器

再次检查视频#1，这是将注意力放在每个AM启动时容器的数量，将会注意到容器的数量总是等于你定义的容器数量+1（这个额外的容器运行的是AM - Application Master）

### 理解#3 - 当Tez AM初始化时（调用AM池）
如果你没有指定队列的名字（tez.queue.name），一个查询将只会使用池中的一个Tez AM（如上所述的初始），在这个情况中，Hiveserver2将只会选择一个空闲的或者可用的Tez AM（随机选择一个队列名）。如果使用相同的JDBC/ODBC执行多种查询时，每个查询都将在不同的Tez AM中执行和每个查询会在不同的队列名中被执行。

如果在你的JDBC/ODBC连接中制定了队列名，hiveserver2将会为该连接创建一个新的Tez AM并且不会使用任何初始化的会话。

PS：只有jdbc/odbc客户端可以使用初始的Tez AM，hive client（命令行）或者其它外部hive组件不能使用初始化的Tez AM。

### 理解#4 - 如果你有超过Tez AM初始化数量的并发查询，咋办？
如果你没有指定队列名（如上所述）hiveserver2将会持有你的查询直到默认的Tez AM(池)其中的一个可用于服务你的查询。这里将不会有任何的消息在JDBC/OBDC客户端和hiveserver2的日志文件中。一个不懂的用户（或者admin）可能认为JDBC/ODBC连接或者hiveserver2损坏了，但是它仅仅是等待Tez AM去执行查询。

如果你指定了队列名，那么不管有多少的Tez AM在被使用或者空闲都不重要，hiveserver2将为了这个连接创建一个新的Tez AM并且这个查询可被执行（如果队列有可用的资源）

### 理解#5 - 如何使用AM池定制队列名（用户定义）
在使用Tez AM池（初始会话）的同一时间

